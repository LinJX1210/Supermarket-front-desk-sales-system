# 超市前台销售系统 - 数据库设计文档

## 一、数据库概述

- 数据库名称：`supermarket_db`
- 字符集：`utf8mb4`
- 存储引擎：`InnoDB`

## 二、数据表清单

| 序号 | 表名 | 中文名称 | 所属模块 |
|------|------|----------|----------|
| 1 | sys_user | 系统用户表 | 用户权限 |
| 2 | sys_user_log | 用户操作日志表 | 用户权限 |
| 3 | member_level_rule | 会员等级规则表 | 会员管理 |
| 4 | member | 会员表 | 会员管理 |
| 5 | member_change_log | 会员信息变更记录表 | 会员管理 |
| 6 | goods_category | 商品分类表 | 商品管理 |
| 7 | shelf_area | 货架区域表 | 商品管理 |
| 8 | shelf | 货架表 | 商品管理 |
| 9 | goods | 商品表 | 商品管理 |
| 10 | inventory | 库存表 | 商品管理 |
| 11 | goods_operation_log | 商品操作记录表 | 商品管理 |
| 12 | order_info | 订单表 | 收银管理 |
| 13 | order_detail | 订单明细表 | 收银管理 |
| 14 | payment_record | 支付记录表 | 收银管理 |
| 15 | return_record | 退货记录表 | 退货管理 |
| 16 | return_detail | 退货明细表 | 退货管理 |
| 17 | quality_feedback | 质量问题反馈表 | 退货管理 |
| 18 | gift | 礼品表 | 积分兑换 |
| 19 | points_exchange_record | 积分兑换记录表 | 积分兑换 |
| 20 | stock_in_record | 入库记录表 | 商品入库 |
| 21 | sys_notification | 系统通知表 | 系统通知 |

---

## 三、表结构详细说明

### 3.1 sys_user (系统用户表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| user_id | INT | PK, AUTO_INCREMENT | 用户ID |
| username | VARCHAR(50) | NOT NULL, UNIQUE | 用户名 |
| password | VARCHAR(64) | NOT NULL | 密码(MD5加密) |
| real_name | VARCHAR(50) | | 真实姓名 |
| phone | VARCHAR(20) | | 手机号 |
| role | ENUM | NOT NULL | 角色: admin/cashier/goods_manager/after_sale |
| status | ENUM | DEFAULT 'active' | 状态: active/disabled |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | ON UPDATE | 更新时间 |

**角色说明：**
- `admin` - 系统管理员
- `cashier` - 收银员
- `goods_manager` - 商品管理员
- `after_sale` - 售后管理员

---

### 3.2 sys_user_log (用户操作日志表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| log_id | INT | PK, AUTO_INCREMENT | 日志ID |
| user_id | INT | FK → sys_user | 用户ID |
| operation | VARCHAR(100) | NOT NULL | 操作内容 |
| operation_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 操作时间 |
| ip_address | VARCHAR(50) | | IP地址 |

---

### 3.3 member_level_rule (会员等级规则表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| rule_id | INT | PK, AUTO_INCREMENT | 规则ID |
| level_name | VARCHAR(20) | NOT NULL | 等级名称 |
| level_code | ENUM | NOT NULL, UNIQUE | 等级代码: normal/silver/gold |
| min_consume | DECIMAL(12,2) | DEFAULT 0 | 升级所需最低累计消费金额 |
| min_points | INT | DEFAULT 0 | 升级所需最低积分 |
| discount_rate | DECIMAL(3,2) | DEFAULT 1.00 | 折扣比例(如0.95=95折) |
| points_rate | INT | DEFAULT 1 | 积分比例(每消费1元获得积分数) |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | ON UPDATE | 更新时间 |

**等级说明：**
- `normal` - 普通会员
- `silver` - 银卡会员
- `gold` - 金卡会员

---

### 3.4 member (会员表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| member_id | INT | PK, AUTO_INCREMENT | 会员ID |
| user_id | INT | FK → sys_user | 关联用户ID(可选) |
| card_no | VARCHAR(20) | NOT NULL, UNIQUE | 会员卡号 |
| name | VARCHAR(50) | NOT NULL | 会员姓名 |
| phone | VARCHAR(20) | | 手机号 |
| address | VARCHAR(200) | | 地址 |
| level_code | ENUM | DEFAULT 'normal' | 会员等级 |
| total_consume | DECIMAL(12,2) | DEFAULT 0 | 累计消费金额 |
| total_points | INT | DEFAULT 0 | 当前积分 |
| status | ENUM | DEFAULT 'active' | 状态: active/disabled |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 注册时间 |
| update_time | DATETIME | ON UPDATE | 更新时间 |

---

### 3.5 member_change_log (会员信息变更记录表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| log_id | INT | PK, AUTO_INCREMENT | 日志ID |
| member_id | INT | FK → member | 会员ID |
| change_type | VARCHAR(50) | NOT NULL | 变更类型: info/level_up/level_down/points |
| old_value | VARCHAR(200) | | 变更前值 |
| new_value | VARCHAR(200) | | 变更后值 |
| change_reason | VARCHAR(200) | | 变更原因 |
| operator_id | INT | FK → sys_user | 操作人ID |
| change_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 变更时间 |

---

### 3.6 goods_category (商品分类表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| category_id | INT | PK, AUTO_INCREMENT | 分类ID |
| category_name | VARCHAR(50) | NOT NULL | 分类名称 |
| parent_id | INT | FK → goods_category | 父分类ID |
| level | TINYINT | NOT NULL | 层级: 1-课, 2-类, 3-种 |
| sort_order | INT | DEFAULT 0 | 排序号 |
| delete_flag | TINYINT | DEFAULT 0 | 删除标记: 0-正常, 1-已删除 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | ON UPDATE | 更新时间 |

**层级说明：**
- `1` - 课 (如：食品课)
- `2` - 类 (如：膨化食品类)
- `3` - 种 (如：雪饼)

---

### 3.7 shelf_area (货架区域表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| area_id | INT | PK, AUTO_INCREMENT | 区域ID |
| area_code | VARCHAR(10) | NOT NULL, UNIQUE | 区域编码(如A, B, C) |
| area_name | VARCHAR(50) | | 区域名称 |
| description | VARCHAR(200) | | 区域描述 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

---

### 3.8 shelf (货架表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| shelf_id | INT | PK, AUTO_INCREMENT | 货架ID |
| area_id | INT | FK → shelf_area | 所属区域ID |
| shelf_code | VARCHAR(20) | NOT NULL, UNIQUE | 货架编码(区-架-层, 如A-01-02) |
| shelf_no | VARCHAR(10) | NOT NULL | 货架号 |
| layer_no | VARCHAR(10) | NOT NULL | 层号 |
| capacity | INT | DEFAULT 100 | 容量 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

---

### 3.9 goods (商品表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| goods_id | INT | PK, AUTO_INCREMENT | 商品ID |
| barcode | VARCHAR(50) | NOT NULL, UNIQUE | 商品条码 |
| goods_name | VARCHAR(100) | NOT NULL | 商品名称 |
| category_id | INT | FK → goods_category | 分类ID(种级别) |
| unit | VARCHAR(20) | DEFAULT '个' | 单位 |
| is_weighted | TINYINT | DEFAULT 0 | 是否散装称重: 0-否, 1-是 |
| price | DECIMAL(10,2) | NOT NULL | 销售单价 |
| cost_price | DECIMAL(10,2) | | 成本价 |
| shelf_id | INT | FK → shelf | 货架ID |
| shelf_status | ENUM | DEFAULT 'pending_shelf' | 上架状态 |
| discount | DECIMAL(3,2) | DEFAULT 1.00 | 临时折扣 |
| discount_start | DATETIME | | 折扣开始时间 |
| discount_end | DATETIME | | 折扣结束时间 |
| off_shelf_reason | VARCHAR(200) | | 下架原因 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | ON UPDATE | 更新时间 |

**上架状态说明：**
- `pending_shelf` - 待上架
- `on_shelf` - 在架
- `off_shelf` - 已下架
- `pending_inspect` - 待质检
- `suspend_sale` - 暂停销售

---

### 3.10 inventory (库存表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| inventory_id | INT | PK, AUTO_INCREMENT | 库存ID |
| goods_id | INT | FK → goods, UNIQUE | 商品ID |
| stock_num | INT | DEFAULT 0 | 库存数量(仓库) |
| on_shelf_num | INT | DEFAULT 0 | 在架数量 |
| stock_warning | INT | DEFAULT 10 | 库存警戒值 |
| shelf_warning | INT | DEFAULT 5 | 在架警戒值 |
| stock_status | ENUM | DEFAULT 'sufficient' | 库存状态 |
| update_time | DATETIME | ON UPDATE | 更新时间 |

**库存状态说明：**
- `sufficient` - 充足
- `stock_shortage` - 库存短缺
- `shelf_shortage` - 在架短缺

---

### 3.11 goods_operation_log (商品操作记录表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| log_id | INT | PK, AUTO_INCREMENT | 日志ID |
| goods_id | INT | FK → goods | 商品ID |
| operation_type | VARCHAR(50) | NOT NULL | 操作类型 |
| old_value | VARCHAR(200) | | 变更前值 |
| new_value | VARCHAR(200) | | 变更后值 |
| operator_id | INT | FK → sys_user | 操作人ID |
| operation_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 操作时间 |
| remark | VARCHAR(200) | | 备注 |

**操作类型说明：**
- `on_shelf` - 上架
- `off_shelf` - 下架
- `move_shelf` - 移架
- `price_change` - 调价
- `discount_set` - 设置折扣

---

### 3.12 order_info (订单表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| order_id | INT | PK, AUTO_INCREMENT | 订单ID |
| order_no | VARCHAR(30) | NOT NULL, UNIQUE | 订单号 |
| member_id | INT | FK → member | 会员ID(非会员为空) |
| cashier_id | INT | FK → sys_user | 收银员ID |
| total_amount | DECIMAL(12,2) | NOT NULL | 订单总金额 |
| discount_amount | DECIMAL(12,2) | DEFAULT 0 | 折扣金额 |
| actual_amount | DECIMAL(12,2) | NOT NULL | 实付金额 |
| points_earned | INT | DEFAULT 0 | 本单获得积分 |
| points_used | INT | DEFAULT 0 | 本单使用积分 |
| order_status | ENUM | DEFAULT 'pending_pay' | 订单状态 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| complete_time | DATETIME | | 完成时间 |

**订单状态说明：**
- `pending_pay` - 待结账
- `hanged` - 挂单中
- `completed` - 已完成
- `cancelled` - 已撤销
- `full_returned` - 已整单退货
- `part_returned` - 部分退货

---

### 3.13 order_detail (订单明细表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| detail_id | INT | PK, AUTO_INCREMENT | 明细ID |
| order_id | INT | FK → order_info | 订单ID |
| goods_id | INT | FK → goods | 商品ID |
| goods_name | VARCHAR(100) | NOT NULL | 商品名称(冗余) |
| barcode | VARCHAR(50) | NOT NULL | 商品条码(冗余) |
| unit_price | DECIMAL(10,2) | NOT NULL | 单价 |
| quantity | DECIMAL(10,3) | NOT NULL | 数量/重量 |
| discount | DECIMAL(3,2) | DEFAULT 1.00 | 折扣 |
| subtotal | DECIMAL(12,2) | NOT NULL | 小计金额 |
| is_returned | TINYINT | DEFAULT 0 | 是否已退货: 0-否, 1-是 |
| returned_quantity | DECIMAL(10,3) | DEFAULT 0 | 已退货数量 |

---

### 3.14 payment_record (支付记录表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| payment_id | INT | PK, AUTO_INCREMENT | 支付ID |
| order_id | INT | FK → order_info | 订单ID |
| payment_type | ENUM | NOT NULL | 支付方式 |
| amount | DECIMAL(12,2) | NOT NULL | 支付金额 |
| transaction_type | ENUM | DEFAULT 'pay' | 交易类型: pay/refund |
| payment_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 支付时间 |

**支付方式说明：**
- `cash` - 现金
- `bank_card` - 银行卡
- `coupon` - 赠券
- `points` - 积分

---

### 3.15 return_record (退货记录表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| return_id | INT | PK, AUTO_INCREMENT | 退货ID |
| return_no | VARCHAR(30) | NOT NULL, UNIQUE | 退货单号 |
| order_id | INT | FK → order_info | 原订单ID |
| return_type | ENUM | NOT NULL | 退货类型: full/part |
| refund_amount | DECIMAL(12,2) | NOT NULL | 退款金额 |
| points_deducted | INT | DEFAULT 0 | 扣减积分 |
| return_reason | ENUM | NOT NULL | 退货原因 |
| reason_detail | VARCHAR(500) | | 原因详情/质量问题描述 |
| quality_photo | VARCHAR(500) | | 质量问题照片路径 |
| operator_id | INT | FK → sys_user | 售后管理员ID |
| return_status | ENUM | DEFAULT 'completed' | 退货状态 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 退货时间 |

**退货类型说明：**
- `full` - 整单退货
- `part` - 部分退货

**退货原因说明：**
- `quality_issue` - 质量问题
- `no_reason_7day` - 7天无理由
- `spec_mismatch` - 规格不符
- `damaged` - 损坏
- `other` - 其他

---

### 3.16 return_detail (退货明细表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| detail_id | INT | PK, AUTO_INCREMENT | 明细ID |
| return_id | INT | FK → return_record | 退货ID |
| order_detail_id | INT | FK → order_detail | 原订单明细ID |
| goods_id | INT | FK → goods | 商品ID |
| return_quantity | DECIMAL(10,3) | NOT NULL | 退货数量 |
| refund_amount | DECIMAL(12,2) | NOT NULL | 退款金额 |
| return_reason | ENUM | NOT NULL | 退货原因 |
| goods_status | ENUM | DEFAULT 'to_stock' | 商品去向 |

**商品去向说明：**
- `to_stock` - 转入库存
- `pending_inspect` - 待质检
- `off_shelf` - 已下架
- `repaired` - 修缮后上架

---

### 3.17 quality_feedback (质量问题反馈表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| feedback_id | INT | PK, AUTO_INCREMENT | 反馈ID |
| return_id | INT | FK → return_record | 退货ID |
| goods_id | INT | FK → goods | 商品ID |
| barcode | VARCHAR(50) | NOT NULL | 商品条码 |
| problem_desc | VARCHAR(500) | | 问题描述 |
| photo_path | VARCHAR(500) | | 问题照片路径 |
| feedback_status | ENUM | DEFAULT 'pending' | 反馈状态 |
| handle_result | ENUM | | 处理结果 |
| handle_remark | VARCHAR(500) | | 处理备注 |
| handler_id | INT | FK → sys_user | 处理人(商品管理员)ID |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| handle_time | DATETIME | | 处理时间 |
| last_remind_time | DATETIME | | 上次提醒时间 |

**反馈状态说明：**
- `pending` - 待处理
- `processing` - 处理中
- `completed` - 已完成

**处理结果说明：**
- `batch_off_shelf` - 批量下架
- `single_off_shelf` - 单个下架
- `repair` - 修缮
- `no_action` - 无需处理

---

### 3.18 gift (礼品表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| gift_id | INT | PK, AUTO_INCREMENT | 礼品ID |
| gift_name | VARCHAR(100) | NOT NULL | 礼品名称 |
| gift_desc | VARCHAR(500) | | 礼品描述 |
| points_required | INT | NOT NULL | 所需积分 |
| stock_num | INT | DEFAULT 0 | 库存数量 |
| status | ENUM | DEFAULT 'active' | 状态: active-可兑换, inactive-已下架 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | ON UPDATE | 更新时间 |

---

### 3.19 points_exchange_record (积分兑换记录表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| record_id | INT | PK, AUTO_INCREMENT | 记录ID |
| member_id | INT | FK → member | 会员ID |
| exchange_type | ENUM | NOT NULL | 兑换类型: gift-礼品, cash-抵扣现金 |
| gift_id | INT | FK → gift | 礼品ID(兑换礼品时) |
| points_used | INT | NOT NULL | 使用积分 |
| cash_amount | DECIMAL(10,2) | | 抵扣金额(抵扣现金时) |
| order_id | INT | FK → order_info | 关联订单ID(抵扣现金时) |
| operator_id | INT | FK → sys_user | 操作人ID |
| exchange_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 兑换时间 |

---

### 3.20 stock_in_record (入库记录表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| record_id | INT | PK, AUTO_INCREMENT | 入库记录ID |
| goods_id | INT | FK → goods | 商品ID |
| quantity | INT | NOT NULL | 入库数量 |
| batch_no | VARCHAR(50) | | 批次号 |
| supplier | VARCHAR(100) | | 供应商 |
| cost_price | DECIMAL(10,2) | | 进货价 |
| operator_id | INT | FK → sys_user | 操作人ID |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 入库时间 |
| remark | VARCHAR(200) | | 备注 |

---

### 3.21 sys_notification (系统通知表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| notification_id | INT | PK, AUTO_INCREMENT | 通知ID |
| target_user_id | INT | FK → sys_user | 目标用户ID(空表示广播) |
| target_role | ENUM | | 目标角色 |
| notification_type | VARCHAR(50) | NOT NULL | 通知类型 |
| title | VARCHAR(100) | NOT NULL | 通知标题 |
| content | TEXT | | 通知内容 |
| related_id | INT | | 关联业务ID |
| is_read | TINYINT | DEFAULT 0 | 是否已读: 0-未读, 1-已读 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| read_time | DATETIME | | 阅读时间 |

**通知类型说明：**
- `stock_warning` - 库存预警
- `quality_feedback` - 质量反馈
- `member_upgrade` - 会员升级
- `member_downgrade` - 会员降级

---

## 四、表关系图 (ER关系)

```
sys_user (用户表)
    ├── 1:N → sys_user_log (操作日志)
    ├── 1:N → member (会员，可选关联)
    ├── 1:N → order_info (收银员)
    ├── 1:N → return_record (售后管理员)
    ├── 1:N → quality_feedback (处理人)
    ├── 1:N → goods_operation_log (操作人)
    └── 1:N → member_change_log (操作人)

member (会员表)
    ├── N:1 → member_level_rule (会员等级)
    ├── 1:N → member_change_log (变更记录)
    └── 1:N → order_info (消费订单)

goods_category (商品分类)
    ├── 自关联 → parent_id (父分类)
    └── 1:N → goods (商品)

shelf_area (货架区域)
    └── 1:N → shelf (货架)

shelf (货架)
    └── 1:N → goods (商品)

goods (商品表)
    ├── 1:1 → inventory (库存)
    ├── 1:N → goods_operation_log (操作记录)
    ├── 1:N → order_detail (订单明细)
    ├── 1:N → return_detail (退货明细)
    └── 1:N → quality_feedback (质量反馈)

order_info (订单表)
    ├── 1:N → order_detail (订单明细)
    ├── 1:N → payment_record (支付记录)
    └── 1:N → return_record (退货记录)

return_record (退货记录)
    ├── 1:N → return_detail (退货明细)
    └── 1:N → quality_feedback (质量反馈)

gift (礼品表)
    └── 1:N → points_exchange_record (兑换记录)

member (会员表)
    └── 1:N → points_exchange_record (兑换记录)

goods (商品表)
    └── 1:N → stock_in_record (入库记录)
```

---

## 五、索引设计

| 表名 | 索引名 | 索引字段 | 索引类型 |
|------|--------|----------|----------|
| sys_user | idx_username | username | UNIQUE |
| sys_user | idx_role | role | INDEX |
| member | idx_card_no | card_no | UNIQUE |
| member | idx_phone | phone | INDEX |
| member | idx_level | level_code | INDEX |
| goods | idx_barcode | barcode | UNIQUE |
| goods | idx_category | category_id | INDEX |
| goods | idx_shelf_status | shelf_status | INDEX |
| inventory | idx_status | stock_status | INDEX |
| order_info | idx_order_no | order_no | UNIQUE |
| order_info | idx_member | member_id | INDEX |
| order_info | idx_status | order_status | INDEX |
| order_info | idx_create_time | create_time | INDEX |
| return_record | idx_return_no | return_no | UNIQUE |
| return_record | idx_order | order_id | INDEX |
| quality_feedback | idx_status | feedback_status | INDEX |
| points_exchange_record | idx_member | member_id | INDEX |
| stock_in_record | idx_goods | goods_id | INDEX |
| stock_in_record | idx_create_time | create_time | INDEX |
| sys_notification | idx_target_user | target_user_id | INDEX |
| sys_notification | idx_is_read | is_read | INDEX |

---

## 六、初始化数据

### 6.1 会员等级规则初始数据

| 等级名称 | 等级代码 | 最低消费 | 最低积分 | 折扣 | 积分比例 |
|----------|----------|----------|----------|------|----------|
| 普通会员 | normal | 0 | 0 | 1.00 | 1 |
| 银卡会员 | silver | 1000 | 1000 | 0.95 | 2 |
| 金卡会员 | gold | 5000 | 5000 | 0.90 | 3 |

### 6.2 默认管理员账号

| 用户名 | 密码 | 角色 |
|--------|------|------|
| admin | admin123 | 系统管理员 |

---

## 七、物理数据库设计

### 7.1 数据冗余设计

为提高查询效率，本系统在以下位置引入了必要的数据冗余：

**（1）order_detail 订单明细表的冗余字段：**
- `goods_name`：冗余存储商品名称，避免每次查询订单明细时都要关联goods表
- `barcode`：冗余存储商品条码，便于小票打印和退货核对时快速获取

**冗余原因：** 订单明细是高频查询表，收银小票打印、订单查询、退货核对都需要显示商品名称和条码。如果每次都关联goods表，会增加查询开销。同时，商品名称可能会修改，冗余存储可以保留下单时的商品名称，保证历史数据准确性。

**（2）quality_feedback 质量反馈表的冗余字段：**
- `barcode`：冗余存储商品条码，便于商品管理员快速识别问题商品

**冗余原因：** 质量反馈需要快速定位问题商品，冗余条码可以避免关联goods表。

### 7.2 数据冗余异常控制方案

**（1）插入异常控制：**
- order_detail插入时，从goods表读取当前的goods_name和barcode写入冗余字段
- quality_feedback插入时，从goods表读取当前的barcode写入冗余字段
- 通过应用层代码保证冗余数据的一致性

**（2）更新异常控制：**
- goods表的goods_name或barcode修改时，不同步更新历史订单明细中的冗余字段（保留历史快照）
- 如需同步更新，可通过触发器实现，但本系统选择保留历史数据

**（3）删除异常控制：**
- goods表采用逻辑删除（通过shelf_status设为off_shelf），不物理删除，避免订单明细的外键失效
- goods_category表采用软删除（delete_flag字段），保留历史分类记录

**（4）事务控制：**
- 收银结账时，订单创建、明细插入、库存扣减、积分累计等操作在同一事务中完成
- 退货处理时，退货记录创建、库存恢复、积分扣减等操作在同一事务中完成
- 任一步骤失败则整体回滚，保证数据一致性

### 7.3 索引设计说明

**（1）唯一索引（保证数据唯一性）：**

| 表名 | 索引字段 | 说明 |
|------|----------|------|
| sys_user | username | 用户名唯一 |
| member | card_no | 会员卡号唯一 |
| goods | barcode | 商品条码唯一 |
| shelf | shelf_code | 货架编码唯一 |
| shelf_area | area_code | 区域编码唯一 |
| order_info | order_no | 订单号唯一 |
| return_record | return_no | 退货单号唯一 |

**（2）普通索引（提高查询效率）：**

| 表名 | 索引字段 | 查询场景 |
|------|----------|----------|
| sys_user | role | 按角色筛选用户 |
| member | phone | 按手机号查询会员 |
| member | level_code | 按等级统计会员 |
| goods | category_id | 按分类查询商品 |
| goods | shelf_status | 按上架状态筛选商品 |
| inventory | stock_status | 筛选库存短缺商品 |
| order_info | member_id | 查询会员消费记录 |
| order_info | order_status | 按状态筛选订单（挂单、已完成等） |
| order_info | create_time | 按时间范围查询订单（统计报表） |
| order_detail | order_id | 查询订单明细 |
| payment_record | order_id | 查询订单支付记录 |
| return_record | order_id | 查询订单退货记录 |
| return_detail | return_id | 查询退货明细 |
| quality_feedback | feedback_status | 筛选待处理的质量反馈 |
| stock_in_record | goods_id | 查询商品入库记录 |
| stock_in_record | create_time | 按时间查询入库记录 |
| points_exchange_record | member_id | 查询会员积分兑换记录 |
| sys_notification | target_user_id | 查询用户通知 |
| sys_notification | is_read | 筛选未读通知 |
| goods_category | parent_id | 查询子分类 |
| goods_category | level | 按层级查询分类 |

**（3）复合索引建议（可根据实际查询优化添加）：**

```sql
-- 订单按时间+状态查询（统计报表常用）
CREATE INDEX idx_order_time_status ON order_info(create_time, order_status);

-- 商品按分类+状态查询
CREATE INDEX idx_goods_category_status ON goods(category_id, shelf_status);

-- 会员按等级+状态查询
CREATE INDEX idx_member_level_status ON member(level_code, status);
```

---


### 7.4 数据库用户与权限设计

本系统根据不同角色创建不同的数据库用户，每个角色只能访问其职责范围内的数据。

**（1）数据库用户清单：**

| 数据库用户名 | 对应系统角色 | 说明 |
|--------------|--------------|------|
| sm_admin | 系统管理员 | 拥有所有表的完全权限 |
| sm_cashier | 收银员 | 订单相关表的读写权限 |
| sm_goods_manager | 商品管理员 | 商品和库存相关表的读写权限 |
| sm_after_sale | 售后管理员 | 退货相关表的读写权限 |

**（2）各用户权限分配：**

**sm_admin（系统管理员）：**
- 拥有supermarket_db数据库的所有权限（ALL PRIVILEGES）
- 可以管理所有用户、会员、商品、订单、退货等数据
- 可以创建和管理其他数据库用户

**sm_cashier（收银员）：**
- SELECT权限：sys_user（仅自己）、member、member_level_rule、goods、inventory、order_info、order_detail、payment_record
- INSERT权限：order_info、order_detail、payment_record、member_change_log（积分变动）
- UPDATE权限：order_info（订单状态）、member（积分和消费金额）、inventory（库存扣减）
- 无DELETE权限

**sm_goods_manager（商品管理员）：**
- SELECT权限：sys_user（仅自己）、goods_category、shelf_area、shelf、goods、inventory、goods_operation_log、stock_in_record、quality_feedback、sys_notification
- INSERT权限：goods_category、shelf_area、shelf、goods、inventory、goods_operation_log、stock_in_record
- UPDATE权限：goods_category、goods、inventory、quality_feedback（处理结果）
- 无DELETE权限（分类采用软删除）

**sm_after_sale（售后管理员）：**
- SELECT权限：sys_user（仅自己）、member、order_info、order_detail、payment_record、return_record、return_detail、quality_feedback、goods
- INSERT权限：return_record、return_detail、quality_feedback、payment_record（退款记录）
- UPDATE权限：order_info（退货状态）、order_detail（退货标记）、member（积分扣减）、inventory（库存恢复）
- 无DELETE权限

**（3）权限创建SQL脚本：**

```sql
-- 创建数据库用户
CREATE USER 'sm_admin'@'localhost' IDENTIFIED BY 'admin_password';
CREATE USER 'sm_cashier'@'localhost' IDENTIFIED BY 'cashier_password';
CREATE USER 'sm_goods_manager'@'localhost' IDENTIFIED BY 'goods_password';
CREATE USER 'sm_after_sale'@'localhost' IDENTIFIED BY 'aftersale_password';

-- 系统管理员：所有权限
GRANT ALL PRIVILEGES ON supermarket_db.* TO 'sm_admin'@'localhost';

-- 收银员权限
GRANT SELECT ON supermarket_db.member TO 'sm_cashier'@'localhost';
GRANT SELECT ON supermarket_db.member_level_rule TO 'sm_cashier'@'localhost';
GRANT SELECT ON supermarket_db.goods TO 'sm_cashier'@'localhost';
GRANT SELECT ON supermarket_db.inventory TO 'sm_cashier'@'localhost';
GRANT SELECT, INSERT, UPDATE ON supermarket_db.order_info TO 'sm_cashier'@'localhost';
GRANT SELECT, INSERT ON supermarket_db.order_detail TO 'sm_cashier'@'localhost';
GRANT SELECT, INSERT ON supermarket_db.payment_record TO 'sm_cashier'@'localhost';
GRANT UPDATE (total_consume, total_points) ON supermarket_db.member TO 'sm_cashier'@'localhost';
GRANT UPDATE (on_shelf_num, stock_status) ON supermarket_db.inventory TO 'sm_cashier'@'localhost';
GRANT INSERT ON supermarket_db.member_change_log TO 'sm_cashier'@'localhost';

-- 商品管理员权限
GRANT SELECT, INSERT, UPDATE ON supermarket_db.goods_category TO 'sm_goods_manager'@'localhost';
GRANT SELECT, INSERT ON supermarket_db.shelf_area TO 'sm_goods_manager'@'localhost';
GRANT SELECT, INSERT ON supermarket_db.shelf TO 'sm_goods_manager'@'localhost';
GRANT SELECT, INSERT, UPDATE ON supermarket_db.goods TO 'sm_goods_manager'@'localhost';
GRANT SELECT, INSERT, UPDATE ON supermarket_db.inventory TO 'sm_goods_manager'@'localhost';
GRANT SELECT, INSERT ON supermarket_db.goods_operation_log TO 'sm_goods_manager'@'localhost';
GRANT SELECT, INSERT ON supermarket_db.stock_in_record TO 'sm_goods_manager'@'localhost';
GRANT SELECT, UPDATE ON supermarket_db.quality_feedback TO 'sm_goods_manager'@'localhost';
GRANT SELECT ON supermarket_db.sys_notification TO 'sm_goods_manager'@'localhost';

-- 售后管理员权限
GRANT SELECT ON supermarket_db.member TO 'sm_after_sale'@'localhost';
GRANT SELECT ON supermarket_db.order_info TO 'sm_after_sale'@'localhost';
GRANT SELECT ON supermarket_db.order_detail TO 'sm_after_sale'@'localhost';
GRANT SELECT ON supermarket_db.payment_record TO 'sm_after_sale'@'localhost';
GRANT SELECT ON supermarket_db.goods TO 'sm_after_sale'@'localhost';
GRANT SELECT, INSERT ON supermarket_db.return_record TO 'sm_after_sale'@'localhost';
GRANT SELECT, INSERT ON supermarket_db.return_detail TO 'sm_after_sale'@'localhost';
GRANT SELECT, INSERT ON supermarket_db.quality_feedback TO 'sm_after_sale'@'localhost';
GRANT INSERT ON supermarket_db.payment_record TO 'sm_after_sale'@'localhost';
GRANT UPDATE (order_status) ON supermarket_db.order_info TO 'sm_after_sale'@'localhost';
GRANT UPDATE (is_returned, returned_quantity) ON supermarket_db.order_detail TO 'sm_after_sale'@'localhost';
GRANT UPDATE (total_consume, total_points, level_code) ON supermarket_db.member TO 'sm_after_sale'@'localhost';
GRANT UPDATE (stock_num, on_shelf_num, stock_status) ON supermarket_db.inventory TO 'sm_after_sale'@'localhost';
GRANT INSERT ON supermarket_db.member_change_log TO 'sm_after_sale'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 7.5 视图设计

为简化查询和增强安全性，创建以下视图：

**（1）收银员视图：**

```sql
-- 在架商品视图（收银员只能看到在架且有库存的商品）
CREATE VIEW v_goods_on_sale AS
SELECT g.goods_id, g.barcode, g.goods_name, g.price, g.discount, 
       g.discount_start, g.discount_end, g.unit, g.is_weighted,
       i.on_shelf_num, gc.category_name
FROM goods g
JOIN inventory i ON g.goods_id = i.goods_id
JOIN goods_category gc ON g.category_id = gc.category_id
WHERE g.shelf_status = 'on_shelf' AND i.on_shelf_num > 0;

-- 会员信息视图（收银员只能看到必要的会员信息）
CREATE VIEW v_member_info AS
SELECT m.member_id, m.card_no, m.name, m.phone, m.level_code,
       m.total_points, mlr.discount_rate, mlr.points_rate
FROM member m
JOIN member_level_rule mlr ON m.level_code = mlr.level_code
WHERE m.status = 'active';

-- 挂单订单视图
CREATE VIEW v_hanged_orders AS
SELECT o.order_id, o.order_no, o.total_amount, o.create_time,
       m.card_no AS member_card, m.name AS member_name
FROM order_info o
LEFT JOIN member m ON o.member_id = m.member_id
WHERE o.order_status = 'hanged';
```

**（2）商品管理员视图：**

```sql
-- 库存预警视图（低于警戒值的商品）
CREATE VIEW v_inventory_warning AS
SELECT g.goods_id, g.barcode, g.goods_name, g.shelf_status,
       i.stock_num, i.on_shelf_num, i.stock_warning, i.shelf_warning, i.stock_status,
       s.shelf_code, gc.category_name
FROM goods g
JOIN inventory i ON g.goods_id = i.goods_id
LEFT JOIN shelf s ON g.shelf_id = s.shelf_id
JOIN goods_category gc ON g.category_id = gc.category_id
WHERE i.stock_status IN ('stock_shortage', 'shelf_shortage');

-- 待处理质量反馈视图
CREATE VIEW v_pending_quality_feedback AS
SELECT qf.feedback_id, qf.barcode, qf.problem_desc, qf.photo_path,
       qf.create_time, qf.last_remind_time,
       g.goods_name, rr.return_no
FROM quality_feedback qf
JOIN goods g ON qf.goods_id = g.goods_id
JOIN return_record rr ON qf.return_id = rr.return_id
WHERE qf.feedback_status = 'pending';

-- 商品分类树视图
CREATE VIEW v_category_tree AS
SELECT c1.category_id, c1.category_name,
       c1.level, c1.parent_id,
       c2.category_name AS parent_name
FROM goods_category c1
LEFT JOIN goods_category c2 ON c1.parent_id = c2.category_id
WHERE c1.delete_flag = 0;
```

**（3）售后管理员视图：**

```sql
-- 可退货订单视图（7天内已完成的订单）
CREATE VIEW v_returnable_orders AS
SELECT o.order_id, o.order_no, o.member_id, o.total_amount, 
       o.actual_amount, o.create_time, o.complete_time,
       m.card_no, m.name AS member_name, m.phone
FROM order_info o
LEFT JOIN member m ON o.member_id = m.member_id
WHERE o.order_status = 'completed' 
  AND o.complete_time >= DATE_SUB(NOW(), INTERVAL 7 DAY);

-- 退货记录汇总视图
CREATE VIEW v_return_summary AS
SELECT rr.return_id, rr.return_no, rr.return_type, rr.refund_amount,
       rr.return_reason, rr.create_time,
       o.order_no, m.card_no, m.name AS member_name,
       u.real_name AS operator_name
FROM return_record rr
JOIN order_info o ON rr.order_id = o.order_id
LEFT JOIN member m ON o.member_id = m.member_id
JOIN sys_user u ON rr.operator_id = u.user_id;
```

**（4）统计报表视图：**

```sql
-- 每日销售汇总视图
CREATE VIEW v_daily_sales AS
SELECT DATE(create_time) AS sale_date,
       COUNT(*) AS order_count,
       SUM(total_amount) AS total_sales,
       SUM(discount_amount) AS total_discount,
       SUM(actual_amount) AS actual_sales
FROM order_info
WHERE order_status = 'completed'
GROUP BY DATE(create_time);

-- 商品销售排行视图
CREATE VIEW v_goods_sales_rank AS
SELECT g.goods_id, g.barcode, g.goods_name, gc.category_name,
       SUM(od.quantity) AS total_quantity,
       SUM(od.subtotal) AS total_amount
FROM order_detail od
JOIN goods g ON od.goods_id = g.goods_id
JOIN goods_category gc ON g.category_id = gc.category_id
JOIN order_info o ON od.order_id = o.order_id
WHERE o.order_status = 'completed'
GROUP BY g.goods_id, g.barcode, g.goods_name, gc.category_name;

-- 会员消费排行视图
CREATE VIEW v_member_consume_rank AS
SELECT m.member_id, m.card_no, m.name, m.level_code,
       m.total_consume, m.total_points,
       COUNT(o.order_id) AS order_count
FROM member m
LEFT JOIN order_info o ON m.member_id = o.member_id AND o.order_status = 'completed'
GROUP BY m.member_id, m.card_no, m.name, m.level_code, m.total_consume, m.total_points;
```

**（5）视图权限分配：**

```sql
-- 收银员视图权限
GRANT SELECT ON supermarket_db.v_goods_on_sale TO 'sm_cashier'@'localhost';
GRANT SELECT ON supermarket_db.v_member_info TO 'sm_cashier'@'localhost';
GRANT SELECT ON supermarket_db.v_hanged_orders TO 'sm_cashier'@'localhost';

-- 商品管理员视图权限
GRANT SELECT ON supermarket_db.v_inventory_warning TO 'sm_goods_manager'@'localhost';
GRANT SELECT ON supermarket_db.v_pending_quality_feedback TO 'sm_goods_manager'@'localhost';
GRANT SELECT ON supermarket_db.v_category_tree TO 'sm_goods_manager'@'localhost';

-- 售后管理员视图权限
GRANT SELECT ON supermarket_db.v_returnable_orders TO 'sm_after_sale'@'localhost';
GRANT SELECT ON supermarket_db.v_return_summary TO 'sm_after_sale'@'localhost';

-- 统计视图权限（管理员可用）
GRANT SELECT ON supermarket_db.v_daily_sales TO 'sm_admin'@'localhost';
GRANT SELECT ON supermarket_db.v_goods_sales_rank TO 'sm_admin'@'localhost';
GRANT SELECT ON supermarket_db.v_member_consume_rank TO 'sm_admin'@'localhost';
```

---

## 八、使用说明

1. 执行 `db/schema.sql` 创建数据库和所有表
2. 执行第7.4节的权限创建SQL脚本，创建数据库用户并分配权限
3. 执行第7.5节的视图创建SQL脚本，创建各角色视图
4. 修改 `config.py` 中的数据库连接配置
5. 应用程序根据登录用户的角色，使用对应的数据库用户连接数据库
6. 使用默认管理员账号（admin/admin123）登录系统
